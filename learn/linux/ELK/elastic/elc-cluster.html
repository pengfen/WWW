集群(cluster) 节点(node) 分片(shard)

Elasticsearch 用于构建高可用和可扩展的系统 扩展的方式可以是购买更好的服务器(纵向扩展vertical scale or scaling up) 或者购买更多的服务器(横向扩展 horizontal scale or scaling out)

Elasticsearch 虽然能从更强大的硬件中获得更好的性能 但是纵向扩展有它的局限性 真正的扩展应该是横向的 它通过增加节点来均摊负载和增加可靠性

一个节点(node)就是一个Elasticsearch实例，而一个集群(cluster)由一个或多个节点组成，它们具有相同的cluster.name，它们协同工作，分享数据和负载。当加入新的节点或者删除一个节点时，集群就会感知到并平衡数据。
集群中一个节点会被选举为主节点(master),它将临时管理集群级别的一些变更，例如新建或删除索引、增加或移除节点等。主节点不参与文档级别的变更或搜索，这意味着在流量增长的时候，该主节点不会成为集群的瓶颈。任何节点都可以成为主节点。我们例子中的集群只有一个节点，所以它会充当主节点的角色。5

做为用户，我们能够与集群中的任何节点通信，包括主节点。每一个节点都知道文档存在于哪个节点上，它们可以转发请求到相应的节点上。我们访问的节点负责收集各节点返回的数据，最后一起返回给客户端。这一切都由Elasticsearch处理。

集群健康
--------------------------------------------------------------
http://192.168.233.132:9200/_cluster/health?pretty 

{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 21,
  "active_shards" : 21,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 21,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 50.0
}

status 集群服务状态
green   所有主要分片和复制分片都可用
yellow  所有主要分片可用 但不是所有复制分片都可用
red     不是所有的主要分片都可用

添加索引
--------------------------------------------------------------
索引只是一个用来指向一个或多个分片(shards)的逻辑命名空间logical namespace
一个分片shard是一个最小级别工作单元worker unit 它本身就是一个完整的搜索引擎 文档存储在分片中 并且在分片中被索引 应用程序不会直接与它们通信 取而代之的是 直接与索引通信
分片可以是主分片(primary shard)或者是复制分片(replica shard)
理论上主分片能存储的数据大小是没有限制的 限制取决于你实际的使用情况 分片的最大容量完全取决于你的使用状况 硬件存储的大小 文档的大小和复杂度 如何索引和查询你的文档 以及你期望的响应时间
当索引创建完成的时候 主分片的数量就固定了 但是复制分片的数量可以随时调整

故障转移
--------------------------------------------------------------
在单一节点上运行意味着单点故障的风险 没有数据备份 幸运的是 要防止单点故障 需要做的就是启动另一个节点

只要第二个节点与第一个节点有相同的cluster.name 它就能自动发现并加入第一个节点所有的集群 如果没有 检查日志找出哪里出了问题 这可能是网络广播被禁用 或者防火墙阻止了节点通信

第二个节点已经加入集群 三个复制分片(replica shards)也已经被分配了 分别对应三个主分片 这意味着在丢失任意一个节点的情况下依旧可以保证数据的完整性

横向扩展
--------------------------------------------------------------
随着应用需求的增长 我们可以增加一个新节点
node3包含了分别来自node1和node2的一个分片 这样每个节点就有两个分片 和之前相比少了一个 这意味着每个节点上的分片将获得更多的硬件资源(CPU PAM I/O)

分片本身就是一个完整的搜索引擎 它可以使用单一节点的所有资源 我们拥有6个分片(3个主分片和三个复制分片) 最多可以扩展到6个节点 每个节点上有一个分片 每个分片可以100%使用这个节点的资源

更多扩展
--------------------------------------------------------------
主分片的数量在创建索引时已经确定 实际上 这个数量定义了能存储到索引里数据的最大数量(实际的数量取决于你的数据 硬件和应用场景) 然而 主分片或者复制分片都可以处理读请求 搜索或文档检索 所以数据的余越多 我们能处理的搜索吞吐量就越大

增加复制分片的数量
PUT /blogs/_settings {"number_of_replicas" : 2}
blogs索引现在有9个分片 3个主分片和6个复制分片 这意味着我们能够扩展到9个节点 再次变成每个节点一个分片 这样使我们的搜索性能相比原始的三节点集群增加三倍

当然 在同样数量的节点上增加更多的复制分片并不能提高性能 因为这样做的话平均每个分片的所占有的硬件资源就减少了(大部分请求都聚集到了分片少的节点 导致一个节点吞吐量太大 反而降低性能) 需要增加硬件来提高吞吐量

应对故障
--------------------------------------------------------------
如果主节点失效 一个集群必须有一个主节点才能使其功能正常 所以集群做的第一件事就是各节点选举了一个新的主节点

